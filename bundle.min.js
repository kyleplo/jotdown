(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?factory(exports):typeof define==="function"&&define.amd?define(["exports"],factory):(global=typeof globalThis!=="undefined"?globalThis:global||self,factory(global.jotdown={}))})(this,function(exports){"use strict";class JotDownChangeEvent extends Event{constructor(){super("change")}}class JotDownSelectionChangeEvent extends Event{constructor(){super("selectionchange")}}function indexOfWithInfinity(a,b){const index=a.indexOf(b);return index<0?Infinity:index}function sanitize(a){return a.replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;")}function setImmediate(a){return setTimeout(a,0)}var autoLink={name:"autoLink",selfClosing:true,format:(next,chain,options)=>{if((next.startsWith("https://")||next.startsWith("http://")||next.startsWith("mailto:"))&&!chain.find(t=>t.startsWith("a href="))){var url=next.slice(0,Math.min(indexOfWithInfinity(next," "),indexOfWithInfinity(next,"\n"),indexOfWithInfinity(next,"\r"),next.length));return{output:'<a href="'+encodeURI(url)+"\" target='"+options.linkTarget+"'>"+(url.startsWith("mailto:")&&options.readonly?url.slice(7):url)+"</a>",advance:url.length}}else{return}}};class InlineFormat{constructor(name,options){this.name=name;this.options=options;this.bounds=options.bounds.map(bound=>[bound,bound]);this.selfClosing=false}format(next,chain,options){const bound=this.options.bounds.find(bound=>next.startsWith(bound));if(bound){var output="";if(chain.includes(this.options.tag)){if(!options.readonly){output+=next.slice(0,bound.length)}var x=chain.indexOf(this.options.tag);output+=chain.slice(0,x).map(t=>"</"+t.split(" ")[0]+">").join("")+"</"+this.options.tag+">"+chain.slice(0,x).map(t=>"<"+t+">").join("");chain.splice(x,1)}else{chain.unshift(this.options.tag);output+="<"+this.options.tag+">";if(!options.readonly){output+=next.slice(0,bound.length)}}return{output:output,advance:bound.length}}else{return}}}var bold=new InlineFormat("bold",{bounds:["**","__"],tag:"strong"});var code=new InlineFormat("code",{bounds:["`"],tag:"code"});var highlight=new InlineFormat("highlight",{bounds:["=="],tag:"span class='jotdown-highlight'"});var image={name:"image",selfClosing:true,bounds:[["![","]()",")"]],format:(next,chain,options)=>{var i=2;if(!next.startsWith("![")){return}var alt="";while(next[i]&&(next[i]!=="]"||next[i-1]&&next[i-1]==="\\")){alt+=next[i];i++}if(!next[i]||!next[i+1]||next[i+1]!=="("){return}i+=2;var url="";while(next[i]&&(next[i]!==")"||next[i-1]&&next[i-1]==="\\")){url+=next[i];i++}if(!next[i]){return}i+=1;if(options.readonly){return{output:"<img src='"+encodeURI(url)+"' alt='"+alt.replaceAll("'","\\'")+"'>",advance:i}}else{return{output:"<a class='jotdown-image-link' href=\""+encodeURI(url)+'" target='+options.linkTarget+">"+next.slice(0,i)+"</a>",advance:i}}}};var italic=new InlineFormat("italic",{bounds:["*","_"],tag:"em"});var link={name:"link",selfClosing:true,bounds:[["[","]()",")"]],format:(next,chain,options)=>{if(next.startsWith("[")&&!chain.find(t=>t.startsWith("a href="))){var i=1;if(!next.startsWith("[")){return}while(next[i]&&(next[i]!=="]"||next[i-1]&&next[i-1]==="\\")){i++}if(!next[i]||!next[i+1]||next[i+1]!=="("){return}i+=2;var url="";while(next[i]&&(next[i]!==")"||next[i-1]&&next[i-1]==="\\")){url+=next[i];i++}if(!next[i]){return}const link='a href="'+url+'" target="'+options.linkTarget+'"';chain.unshift(link);return{output:"<"+link+">"+(options.readonly?"":"["),advance:1}}else if(next.startsWith("](")&&chain.find(t=>t.startsWith("a href="))){return{output:options.readonly?"":"](",advance:2+(options.readonly?next.includes(")")?next.indexOf(")")-2:next.length:0)}}else if(next.startsWith(")")&&chain.find(t=>t.startsWith("a href="))){chain.splice(chain.findIndex(t=>t.startsWith("a href=")),1);return{output:(options.readonly?"":")")+"</a>",advance:1}}else{return}}};var spoiler=new InlineFormat("spoiler",{bounds:["||"],tag:"span class='jotdown-spoiler'"});var strike=new InlineFormat("strike",{bounds:["~~"],tag:"del"});var sub=new InlineFormat("sub",{bounds:["~"],tag:"sub"});var sup=new InlineFormat("sup",{bounds:["^"],tag:"sup"});class BlockFormat{constructor(name,options){this.name=name;this.options=options;this.triggers=options.triggers}format(next,options){const trigger=this.options.triggers.find(trigger=>next.startsWith(trigger));if(trigger){const format=this.options.format(next,options);return{open:format.open,trigger:this.options.excludeTrigger||options.readonly?"":trigger,close:format.close,advance:trigger.length}}else{return}}}var blockquote=new BlockFormat("blockquote",{triggers:["> "],excludeTrigger:true,format:(next,options)=>{if(options.readonly){return{open:"<blockquote>",close:"</blockquote>"}}else{return{open:"<blockquote><strong>&gt;</strong> ",close:"</blockquote>"}}}});var codeFenced={name:"codeFenced",triggers:["```"],format:(next,options)=>{if(next.startsWith("```")){const languageAndCode=next.slice(3,Math.min(indexOfWithInfinity(next,"\n```"),indexOfWithInfinity(next,"\r```"),next.length));var length=3;const language=languageAndCode.slice(0,Math.min(indexOfWithInfinity(languageAndCode,"\n"),indexOfWithInfinity(languageAndCode,"\r"),languageAndCode.length));var code=languageAndCode.slice(Math.min(indexOfWithInfinity(languageAndCode,"\n"),indexOfWithInfinity(languageAndCode,"\r"),languageAndCode.length)+1);length+=code.length+language.length+1;if(language&&options.highlight){code=options.highlight(code,language)}else{code=sanitize(code)}code=code.replaceAll("\n","<br>").replaceAll("\r","<br>");if(code.endsWith("<br>")){code+="&zwj;"}if(next[length]==="\n"||next[length]==="\r"){length++;if(!options.readonly){code+="<br>"}}while(next[length]&&next[length]==="`"){length++;if(!options.readonly){code+="`"}}return{open:"<code class='jotdown-block-code-fenced'>"+(options.readonly?"":"```"+sanitize(language)+"<br>")+code,trigger:"",close:"</code>",advance:length}}else{return}}};var codeIndent=new BlockFormat("codeIndent",{triggers:["    ","\t"],format:(next,options)=>{return{open:"<code class='jotdown-block-code'>",close:"</code>"}}});var h6=new BlockFormat("h6",{triggers:["###### "],format:(next,options)=>{return{open:"<h6>",close:"</h6>"}}});var h5=new BlockFormat("h5",{triggers:["##### "],format:(next,options)=>{return{open:"<h5>",close:"</h5>"}}});var h4=new BlockFormat("h4",{triggers:["#### "],format:(next,options)=>{return{open:"<h4>",close:"</h4>"}}});var h3=new BlockFormat("h3",{triggers:["### "],format:(next,options)=>{return{open:"<h3>",close:"</h3>"}}});var h2=new BlockFormat("h2",{triggers:["## "],format:(next,options)=>{return{open:"<h2>",close:"</h2>"}}});var h1=new BlockFormat("h1",{triggers:["# "],format:(next,options)=>{return{open:"<h1>",close:"</h1>"}}});var all=Object.freeze({__proto__:null,h6:h6,h5:h5,h4:h4,h3:h3,h2:h2,h1:h1});var orderedListActive=false;function getTrigger(next){return next[0]&&!isNaN(parseFloat(next))?next[parseFloat(next).toString().length]==="."||next[parseFloat(next).toString().length]===")"?next[parseFloat(next).toString().length+1]===" "?next.slice(0,parseFloat(next).toString().length+2):next.slice(0,parseFloat(next).toString().length+1):false:false}var orderedList={name:"orderedList",triggers:["1. "],detectTrigger:getTrigger,format:(next,options)=>{const trigger=getTrigger(next);if(trigger){const listIsNew=!orderedListActive;const listContinues=getTrigger(next.slice(Math.min(indexOfWithInfinity(next,"\n")+1,indexOfWithInfinity(next,"\r")+1,next.length)));orderedListActive=(listIsNew||orderedListActive)&&listContinues;return{open:(listIsNew?"<ol>":"")+"<li>",trigger:options.readonly?"":trigger,close:"</li>"+(listContinues?"":"</ol>"),advance:trigger.length}}else{return}},continue:line=>{const trigger=getTrigger(line);if(trigger){return parseFloat(trigger)+1+(parseFloat(trigger).toString().length+1===trigger.length?trigger.slice(trigger.length-1):trigger.slice(trigger.length-2))}else{return false}}};var rule=new BlockFormat("rule",{triggers:["---","***","___","- - -","* * *","_ _ _"],format:(next,options)=>{if(options.readonly){return{open:"<hr>",close:""}}else{return{open:"<p class='jotdown-hr'>",close:"</p>"}}}});const triggers=["- ","+ ","* ","-","+","*"];var unorderedListActive=false;var unorderedList={name:"unorderedList",triggers:triggers,format:(next,options)=>{const trigger=triggers.find(trigger=>next.startsWith(trigger));if(trigger){const listIsNew=!unorderedListActive;const listContinues=!!triggers.find(trigger=>next.includes("\n"+trigger)&&next.indexOf("\n"+trigger)===next.indexOf("\n")||next.includes("\r"+trigger)&&next.indexOf("\r"+trigger)===next.indexOf("\r"));unorderedListActive=(listIsNew||unorderedListActive)&&listContinues;return{open:(listIsNew?"<ul>":"")+"<li>",trigger:options.readonly?"":trigger,close:"</li>"+(listContinues?"":"</ul>"),advance:trigger.length}}else{return}},continue:line=>{const trigger=triggers.find(trigger=>line.startsWith(trigger));if(trigger&&(!line[2]||!triggers.includes(line[2]))){return trigger}else{return false}}};class JotDown extends EventTarget{constructor(container,options){super();this._container=document.createElement("DIV");this._container.classList.add("jotdown-container");container.append(this._container);setImmediate(()=>{this._container.style.setProperty("--jotdown-text-color",window.getComputedStyle(this._container).color)});this._options=Object.assign({readonly:false,mayBecomeWritable:true,inlineFormats:[],blockFormats:[],seekMemory:1e3,linkTarget:"_blank"},options||{});this._order=[];this._preview=document.createElement("DIV");this._preview.classList.add("jotdown-paragraph","jotdown-preview");this._container.append(this._preview);if(this._options.mayBecomeWritable){this._editor=document.createElement("TEXTAREA");this._editor.classList.add("jotdown-paragraph","jotdown-editor");this._editor.addEventListener("input",()=>{this._refresh();super.dispatchEvent(new JotDownChangeEvent)});this._editor.addEventListener("keydown",e=>{if(e.key==="Enter"){this._continueFormat()}});this._container.append(this._editor);document.addEventListener("selectionchange",()=>{if(this._editor.selectionStart!==null&&this._editor.selectionEnd!==null){super.dispatchEvent(new JotDownSelectionChangeEvent)}})}if(this._options.readonly){this._editor.setAttribute("readonly","readonly");this._container.classList.add("jotdown-readonly")}else{this._preview.setAttribute("aria-hidden","true")}}get readonly(){return this._options.readonly}set readonly(newValue){if(this._options.mayBecomeWritable){this._options.readonly=newValue;if(this._options.readonly){this._editor.setAttribute("readonly","readonly");this._preview.removeAttribute("aria-hidden");this._container.classList.add("jotdown-readonly")}else{this._editor.removeAttribute("readonly");this._preview.setAttribute("aria-hidden","true");this._container.classList.remove("jotdown-readonly")}this._refresh()}}applyInlineFormat(format){if(!format.bounds||this._editor.selectionStart===null||this._editor.selectionEnd===null){return false}this._editor.setRangeText(format.bounds[0][0],this._editor.selectionStart,this._editor.selectionStart);this._editor.setRangeText(format.bounds[0][1],this._editor.selectionEnd,this._editor.selectionEnd);super.dispatchEvent(new JotDownChangeEvent);super.dispatchEvent(new JotDownSelectionChangeEvent);this._refresh();return true}removeInlineFormat(format){if(!format.bounds||this._editor.selectionStart===null||this._editor.selectionEnd===null){return false}var successful=false;if(this._editor.selectionStart===this._editor.selectionEnd&&this.detectFormat(format)){this._editor.setRangeText(format.bounds[0][1],this._editor.selectionStart,this._editor.selectionStart);this._editor.setRangeText(format.bounds[0][0],this._editor.selectionEnd,this._editor.selectionEnd);successful=true}else{format.bounds.forEach(bounds=>{if(!successful&&this._editor.value.slice(this._editor.selectionStart-bounds[0].length,this._editor.selectionStart)===bounds[0]&&this._editor.value.slice(this._editor.selectionEnd,this._editor.selectionEnd+bounds[1].length)===bounds[1]){this._editor.setRangeText("",this._editor.selectionStart-bounds[0].length,this._editor.selectionStart);this._editor.setRangeText("",this._editor.selectionEnd,this._editor.selectionEnd+bounds[1].length);successful=true}else if(!successful&&this._editor.value.slice(this._editor.selectionStart,this._editor.selectionStart+bounds[0].length)===bounds[0]&&this._editor.value.slice(this._editor.selectionEnd-bounds[1],this._editor.selectionEnd)===bounds[1]){this._editor.setRangeText("",this._editor.selectionStart,this._editor.selectionStart+bounds[0].length);this._editor.setRangeText("",this._editor.selectionEnd-bounds[1].length,this._editor.selectionEnd);successful=true}})}if(successful){super.dispatchEvent(new JotDownChangeEvent);super.dispatchEvent(new JotDownSelectionChangeEvent);this._refresh()}return successful}applyBlockFormat(format){if(!format.triggers||this._editor.selectionStart===null||this._editor.selectionEnd===null){return false}var i=this._editor.selectionStart;while(i>-1&&this._editor.value[i]!=="\n"&&this._editor.value[i]!=="\r"){i--}i++;this._editor.setRangeText(format.triggers[0],i,i);super.dispatchEvent(new JotDownChangeEvent);super.dispatchEvent(new JotDownSelectionChangeEvent);this._refresh();return true}removeBlockFormat(format){if(!format.triggers||!this._editor.selectionStart||!this._editor.selectionEnd){return false}var i=this._editor.selectionStart;while(i>-1&&this._editor.value[i]!=="\n"&&this._editor.value[i]!=="\r"){i--}i++;if(format.detectTrigger){const works=format.detectTrigger(this._editor.value.slice(i,i+this._options.seekMemory));if(works){this._editor.setRangeText("",i,i+works.length);super.dispatchEvent(new JotDownChangeEvent);super.dispatchEvent(new JotDownSelectionChangeEvent);this._refresh()}return works}else{return!!format.triggers.find(trigger=>{const works=this._editor.value.slice(i,i+this._options.seekMemory).startsWith(trigger);if(works){this._editor.setRangeText("",i,i+trigger.length);super.dispatchEvent(new JotDownChangeEvent);super.dispatchEvent(new JotDownSelectionChangeEvent);this._refresh()}return works})}}detectFormat(format){var i=0;while(this._order[i]&&this._order[i].position<this._editor.selectionStart){i++}i--;const startPosition=i;while(this._order[i]&&this._order[i].position<this._editor.selectionEnd){if(this._order[i].name===format.name&&this._order[i].type==="end"){return false}i++}i=startPosition;while(this._order[i]&&this._order[i].name!==format.name){i--}if(this._order[i]&&this._order[i].name===format.name&&this._order[i].type==="begin"){return true}return false}_refresh(){const input=this._editor.value;this._order=[];var output="";var i=0;var chain=[];var closeLine=null;formatLoop:while(i<input.length){var next=input.slice(i,i+this._options.seekMemory);if(next.startsWith("\n")||next.startsWith("\r")||i===0){output+=chain.map(t=>"</"+t.split(" ")[0]+">").join("");if(closeLine){output+=closeLine.output;this._order.push({position:i,type:"end",name:closeLine.name});closeLine=null}if(next.startsWith("\n")||next.startsWith("\r")){if(i===0){output+="<br>"}next=next.slice(1);i+=1}if(next.startsWith("\n")||next.startsWith("\r")||!next[0]){output+="<br>";continue formatLoop}for(var x=0;x<this._options.blockFormats.length;x++){const format=this._options.blockFormats[x];const result=format.format(next,this._options);if(result){output+=result.open+result.trigger;closeLine={name:format.name,output:result.close};i+=result.advance;output+=chain.map(t=>"<"+t+">").join("");this._order.push({position:i,type:"begin",name:format.name});continue formatLoop}}if(!closeLine){output+="<p>";closeLine={name:"paragraph",output:"</p>"}}output+=chain.map(t=>"<"+t+">").join("")}if(i===0||input[i-1]!=="\\"){for(var x=0;x<this._options.inlineFormats.length;x++){const format=this._options.inlineFormats[x];const result=format.format(next,chain,this._options);if(result){if(this._order.filter(f=>f.name===format.name).length%2===1&&!format.selfClosing){this._order.push({position:i,type:"end",name:format.name})}else{this._order.push({position:i,type:"begin",name:format.name})}output+=result.output;i+=result.advance;if(format.selfClosing){this._order.push({position:i,type:"end",name:format.name})}continue formatLoop}}}if(next[0]==="<"){output+="&lt;";i+=1}else if(next[0]===">"){output+="&gt;";i+=1}else if(next[0]==="\\"&&next[1]!=="\\"&&this._options.readonly){i+=1}else if(next[0]!=="\n"&&next[0]!=="\r"){output+=next[0];i+=1}}output+=chain.map(t=>"</"+t.split(" ")[0]+">").join("");if(closeLine){output+=closeLine.output}this._preview.innerHTML=output}_continueFormat(){var line=this._editor.value.slice(0,this._editor.selectionEnd);line=line.slice(Math.max(line.lastIndexOf("\n")+1,line.lastIndexOf("\r")+1,0));this._options.blockFormats.forEach(format=>{if(format.continue){const continuation=format.continue(line);if(continuation){this._editor.setRangeText(continuation,this._editor.selectionEnd,this._editor.selectionEnd);setImmediate(()=>{this._editor.setRangeText(continuation,this._editor.selectionEnd,this._editor.selectionEnd+continuation.length,"end");super.dispatchEvent(new JotDownChangeEvent);super.dispatchEvent(new JotDownSelectionChangeEvent)});return}}})}get value(){return this._editor.value}set value(newValue){this._editor.value=newValue;this._refresh()}}exports.JotDown=JotDown;exports.autoLink=autoLink;exports.blockquote=blockquote;exports.bold=bold;exports.code=code;exports.codeFenced=codeFenced;exports.codeIndent=codeIndent;exports.heading=all;exports.highlight=highlight;exports.image=image;exports.italic=italic;exports.link=link;exports.orderedList=orderedList;exports.rule=rule;exports.spoiler=spoiler;exports.strike=strike;exports.sub=sub;exports.sup=sup;exports.unorderedList=unorderedList;Object.defineProperty(exports,"__esModule",{value:true})});